<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thêm câu hỏi mới</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      /* Custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="container mx-auto px-4 py-8">
  <div class="bg-white p-6 rounded-xl shadow-lg max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left: Form -->
        <form id="question-form" class="space-y-4">
          <h3 class="text-2xl font-semibold text-gray-800">Thêm câu hỏi mới</h3>

          <div>
            <label for="questionText" class="block text-sm font-medium text-gray-700 mb-1">Nội dung câu hỏi</label>
            <textarea id="questionText" name="questionText" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nhập nội dung câu hỏi..."></textarea>
            <div id="qtext-error" class="text-red-500 text-sm mt-1 hidden">Vui lòng nhập nội dung câu hỏi</div>
          </div>

          <div>
            <label for="questionType" class="block text-sm font-medium text-gray-700 mb-1">Loại câu hỏi</label>
            <select id="questionType" name="questionType" onchange="toggleOptions(); validateQuestionForm();" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="true_false">Đúng / Sai</option>
              <option value="multiple_choice">4 lựa chọn</option>
            </select>
          </div>

          <div id="true-false-options" class="">
            <label class="block text-sm font-medium text-gray-700 mb-1">Đáp án đúng</label>
            <div class="flex gap-6">
              <label class="flex items-center gap-2"><input type="radio" name="correctAnswerTF" value="true" class="h-4 w-4 text-blue-600"/> Đúng</label>
              <label class="flex items-center gap-2"><input type="radio" name="correctAnswerTF" value="false" class="h-4 w-4 text-blue-600"/> Sai</label>
            </div>
            <div id="tf-error" class="text-red-500 text-sm mt-1 hidden">Vui lòng chọn đáp án đúng</div>
          </div>

          <div id="mcq-options" class="hidden">
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Đáp án A</label>
                <input type="text" id="optionA" name="optionA" class="w-full px-3 py-2 border rounded-lg" placeholder="Văn bản đáp án A" />
                <label class="flex items-center gap-2 mt-2"><input type="radio" name="correctAnswerMCQ" value="A" class="h-4 w-4 text-blue-600"/> Đáp án đúng</label>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Đáp án B</label>
                <input type="text" id="optionB" name="optionB" class="w-full px-3 py-2 border rounded-lg" placeholder="Văn bản đáp án B" />
                <label class="flex items-center gap-2 mt-2"><input type="radio" name="correctAnswerMCQ" value="B" class="h-4 w-4 text-blue-600"/> Đáp án đúng</label>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Đáp án C</label>
                <input type="text" id="optionC" name="optionC" class="w-full px-3 py-2 border rounded-lg" placeholder="Văn bản đáp án C" />
                <label class="flex items-center gap-2 mt-2"><input type="radio" name="correctAnswerMCQ" value="C" class="h-4 w-4 text-blue-600"/> Đáp án đúng</label>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Đáp án D</label>
                <input type="text" id="optionD" name="optionD" class="w-full px-3 py-2 border rounded-lg" placeholder="Văn bản đáp án D" />
                <label class="flex items-center gap-2 mt-2"><input type="radio" name="correctAnswerMCQ" value="D" class="h-4 w-4 text-blue-600"/> Đáp án đúng</label>
              </div>
            </div>
            <div id="mcq-error" class="text-red-500 text-sm mt-1 hidden">Vui lòng nhập đủ đáp án và chọn đáp án đúng</div>
          </div>

          <div class="flex gap-3">
            <button id="add-btn" type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg disabled:opacity-60" disabled>Thêm câu hỏi</button>
            <button type="button" onclick="cancel()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg">Hủy</button>
          </div>
        </form>

  <!-- Right: List -->
  <div class="lg:pl-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-2xl font-semibold text-gray-800">Danh sách câu hỏi</h3>
            <div id="question-count" class="text-sm text-gray-600">0 câu</div>
          </div>
          <div id="question-list-container" class="max-h-[680px] min-w-[420px] lg:min-w-[480px] overflow-y-auto custom-scrollbar space-y-3"></div>
        </div>
      </div>
    </div>

    <!-- Modal Sửa câu hỏi -->
    <div
      id="edit-modal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md fade-in">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">
          Sửa câu hỏi
        </h3>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Nội dung câu hỏi:</label
        >
        <input
          type="text"
          id="edit-questionText"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
        />
        <div id="edit-options" class="mb-6 space-y-3"></div>
        <div class="flex justify-center gap-3">
          <button
            onclick="saveEditQuestion()"
            class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition font-medium"
          >
            Lưu
          </button>
          <button
            onclick="closeEditModal()"
            class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition font-medium"
          >
            Hủy
          </button>
        </div>
      </div>
    </div>

    <script>
      function toggleOptions() {
  const type = document.getElementById("questionType").value;
  const tfDiv = document.getElementById("true-false-options");
  const mcqDiv = document.getElementById("mcq-options");

  const tfRadios = document.querySelectorAll('input[name="correctAnswerTF"]');
  const mcqRadios = document.querySelectorAll('input[name="correctAnswerMCQ"]');

  if (type === "true_false") {
    tfDiv.classList.remove("hidden");
    mcqDiv.classList.add("hidden");

    // TF required ON, MCQ required OFF
    tfRadios.forEach(r => r.required = true);
    mcqRadios.forEach(r => r.required = false);
  } else {
    tfDiv.classList.add("hidden");
    mcqDiv.classList.remove("hidden");

    // MCQ required ON, TF required OFF
    tfRadios.forEach(r => r.required = false);
    mcqRadios.forEach(r => r.required = true);
  }
}


      document
        .getElementById("question-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const userId = localStorage.getItem("userId");
          if (!userId) {
            window.location.href = "/login.html";
            return;
          }

          const questionText = document.getElementById("questionText").value;
          const type = document.getElementById("questionType").value;

          let correctAnswer = "";
          const payload = {
            questionText,
            type,
            correctAnswer,
            createdBy: userId,
            options: [],
          };

          if (type === "true_false") {
            const tfAnswer = document.querySelector(
              'input[name="correctAnswerTF"]:checked'
            );
            if (!tfAnswer) {
              showToast('Vui lòng chọn đáp án đúng (Đúng hoặc Sai)!', 'error');
              return;
            }
            console.log("True/False answer:", tfAnswer.value);
            correctAnswer = tfAnswer.value;
            payload.correctAnswer = correctAnswer;
            payload.options = ["true", "false"];
          } else {
            const mcqAnswer = document.querySelector(
              'input[name="correctAnswerMCQ"]:checked'
            );
            if (!mcqAnswer) {
              showToast('Vui lòng chọn đáp án đúng (A, B, C hoặc D)!', 'error');
              return;
            }
            const options = [
              document.querySelector('input[name="optionA"]').value,
              document.querySelector('input[name="optionB"]').value,
              document.querySelector('input[name="optionC"]').value,
              document.querySelector('input[name="optionD"]').value,
            ];
            if (options.some((opt) => !opt.trim())) {
              showToast('Vui lòng nhập đầy đủ các đáp án A, B, C, D!', 'error');
              return;
            }
            console.log("MCQ answer:", mcqAnswer.value, "Options:", options);
            correctAnswer = mcqAnswer.value;
            payload.correctAnswer = correctAnswer;
            payload.options = options;
          }

          fetch("/api/questions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
              }
              return res.json();
            })
            .then((data) => {
              showToast('Thêm câu hỏi thành công!', 'success');
              loadQuestionList();
              document.getElementById('question-form').reset();
              toggleOptions();
            })
            .catch((err) => {
              console.error('Error adding question:', err);
              showToast('Có lỗi xảy ra khi thêm câu hỏi!', 'error');
            });
        });

      function loadQuestionList() {
        fetch("/api/questions")
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((data) => {
            const listContainer = document.getElementById('question-list-container');
            const countEl = document.getElementById('question-count');
            countEl.innerText = `${data.length} câu`;
            listContainer.innerHTML = '';
            data.forEach((question) => {
              const item = document.createElement('div');
              item.className = 'question-item bg-gray-50 p-4 rounded-lg mb-3 shadow-sm hover:shadow-md transition';
              const typeLabel = question.type === 'true_false' ? 'Đúng / Sai' : (question.type === 'multiple_choice' ? '4 lựa chọn' : question.type);
              item.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 pr-4 text-gray-800 font-medium break-words">${question.questionText}</div>
            <div class="text-xs text-gray-600"> <span class="px-2 py-1 bg-gray-100 rounded-md">${typeLabel}</span></div>
          </div>
          <div class="mt-2 flex gap-2">
            <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition" onclick="editQuestion('${question._id}')">Sửa</button>
            <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition" onclick="deleteQuestion('${question._id}')">Xóa</button>
          </div>
        `;
              listContainer.appendChild(item);
            });
          })
          .catch((err) => {
            console.error('Error loading questions:', err);
            showToast('Có lỗi khi tải danh sách câu hỏi: ' + err.message, 'error');
          });
      }

      function deleteQuestion(id) {
        if (window.confirm('Bạn có chắc muốn xóa câu hỏi này không?')) {
          fetch(`/api/questions/${id}`, {
            method: "DELETE",
          })
            .then((res) => {
              if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
              }
              return res.json();
            })
            .then((data) => {
              showToast('Đã xóa câu hỏi!', 'success');
              loadQuestionList();
            })
            .catch((err) => {
              console.error("Error deleting question:", err);
              showToast('Có lỗi khi xóa câu hỏi!', 'error');
            });
        }
      }

      function editQuestion(id) {
        fetch(`/api/questions/${id}`)
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((q) => {
            document.getElementById("edit-modal").classList.remove("hidden");
            document.getElementById("edit-questionText").value = q.questionText;
            window.editingQuestionId = id;

            let html = "";
            if (q.type === "true_false") {
              html += `
                <div class="flex gap-4">
                  <label class="flex items-center gap-2">
                    <input type="radio" name="edit-correctAnswer" value="true" ${
                      q.correctAnswer === "true" ? "checked" : ""
                    } class="h-4 w-4 text-blue-600" /> Đúng
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="radio" name="edit-correctAnswer" value="false" ${
                      q.correctAnswer === "false" ? "checked" : ""
                    } class="h-4 w-4 text-blue-600" /> Sai
                  </label>
                </div>
              `;
            } else {
              for (let i = 0; i < q.options.length; i++) {
                const opt = q.options[i];
                const optLabel = String.fromCharCode(65 + i);
                html += `
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${optLabel}:</label>
                    <input
                      type="text"
                      name="edit-option"
                      value="${opt}"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    />
                    <label class="flex items-center gap-2 mt-1">
                      <input
                        type="radio"
                        name="edit-correctAnswer"
                        value="${optLabel}"
                        ${q.correctAnswer === optLabel ? "checked" : ""}
                        class="h-4 w-4 text-blue-600"
                      /> Đáp án đúng
                    </label>
                  </div>
                `;
              }
            }
            document.getElementById("edit-options").innerHTML = html;
          })
          .catch((err) => {
            console.error('Error loading question:', err);
            showToast('Lỗi khi tải câu hỏi để sửa!', 'error');
          });
      }

      function closeEditModal() {
        document.getElementById("edit-modal").classList.add("hidden");
      }

      function saveEditQuestion() {
        const id = window.editingQuestionId;
        const questionText = document.getElementById("edit-questionText").value;
        const correctAnswer = document.querySelector(
          'input[name="edit-correctAnswer"]:checked'
        )?.value;
        let options = [];

        if (!questionText) {
          showToast('Vui lòng nhập nội dung câu hỏi!', 'error');
          return;
        }
        if (!correctAnswer) {
          showToast('Vui lòng chọn đáp án đúng!', 'error');
          return;
        }

        const type =
          document.querySelector('input[name="edit-correctAnswer"]').value
            .length === 1
            ? "multiple_choice"
            : "true_false";

        if (type === "true_false") {
          options = ["true", "false"];
        } else {
          options = Array.from(
            document.querySelectorAll('input[name="edit-option"]')
          ).map((input) => input.value);
          if (options.some((opt) => !opt.trim())) {
            showToast('Vui lòng nhập đầy đủ các đáp án!', 'error');
            return;
          }
        }

        const payload = {
          questionText,
          type,
          correctAnswer,
          options,
        };

        fetch(`/api/questions/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((data) => {
            showToast('Cập nhật câu hỏi thành công!', 'success');
            closeEditModal();
            loadQuestionList();
          })
          .catch((err) => {
            console.error('Error updating question:', err);
            showToast('Có lỗi khi cập nhật câu hỏi!', 'error');
          });
      }

      function cancel() {
        window.location.href = "/home.html";
      }

      window.onload = function () {
        loadQuestionList();
        toggleOptions();
      };
    </script>
  </body>
</html>
